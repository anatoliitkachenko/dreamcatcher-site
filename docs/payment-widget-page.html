<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–û–ø–ª–∞—Ç–∞...</title>
    <script id="widget-wfp-script" language="javascript" type="text/javascript" src="https://secure.wayforpay.com/server/pay-widget.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f6f8; color: #333; text-align: center; padding: 20px; box-sizing: border-box; }
        .container { padding: 30px; background-color: white; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
        .loader { border: 6px solid #e0e0e0; border-top: 6px solid #007bff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1.2s linear infinite; margin: 25px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        p { font-size: 1.1em; line-height: 1.6; }
        .error-message { color: #d9534f; font-weight: bold; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 25px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 20px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <p id="message">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ–ø–ª–∞—Ç–µ...</p>
        <div class="loader" id="loader"></div>
        <button id="payButton" onclick="triggerPayment()" style="display: none;">–û–ø–ª–∞—Ç–∏—Ç—å</button>
    </div>

    <script>
        // üü¢ –í–ï–°–¨ –≠–¢–û–¢ JAVASCRIPT –ö–û–î –ù–£–ñ–ï–ù:
        const SCRIPT_TEXTS = {
            ru: { init: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ–ø–ª–∞—Ç–µ...", error_details: "–û—à–∏–±–∫–∞: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ (user_id, plan_type, lang).", error_server: "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.", error_widget: "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∂–µ—Ç–∞.", pay_button: "–û–ø–ª–∞—Ç–∏—Ç—å", approved: "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–∫–Ω–æ.", declined: "–û–ø–ª–∞—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.", pending: "–ü–ª–∞—Ç–µ–∂ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –ú—ã —Å–æ–æ–±—â–∏–º –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤ –±–æ—Ç–µ.", redirecting: "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ–ø–ª–∞—Ç—É..." },
            uk: { init: "–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –æ–ø–ª–∞—Ç–∏...", error_details: "–ü–æ–º–∏–ª–∫–∞: –í—ñ–¥—Å—É—Ç–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞—Ü—ñ—ó –ø–ª–∞—Ç–µ–∂—É (user_id, plan_type, lang).", error_server: "–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞.", error_widget: "–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –≤—ñ–¥–∂–µ—Ç–∞.", pay_button: "–°–ø–ª–∞—Ç–∏—Ç–∏", approved: "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–π—à–ª–∞ —É—Å–ø—ñ—à–Ω–æ! –ú–æ–∂–Ω–∞ –∑–∞–∫—Ä–∏—Ç–∏ —Ü–µ –≤—ñ–∫–Ω–æ.", declined: "–û–ø–ª–∞—Ç—É –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ.", pending: "–ü–ª–∞—Ç—ñ–∂ –≤ –æ–±—Ä–æ–±—Ü—ñ. –ú–∏ –ø–æ–≤—ñ–¥–æ–º–∏–º–æ –ø—Ä–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É –±–æ—Ç—ñ.", redirecting: "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ –æ–ø–ª–∞—Ç—É..." },
            en: { init: "Preparing payment...", error_details: "Error: Missing data to initiate payment (user_id, plan_type, lang).", error_server: "Error fetching data from server.", error_widget: "Error initializing widget.", pay_button: "Pay", approved: "Payment successful! You can close this window.", declined: "Payment declined.", pending: "Payment is processing. We will notify you of the result in the bot.", redirecting: "Redirecting to payment..." }
        };

        let userLang = 'ru'; // –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const messageElement = document.getElementById('message');
        const loaderElement = document.getElementById('loader');
        const payButton = document.getElementById('payButton');
        let widgetPaymentParams = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤–∏–¥–∂–µ—Ç–∞

        function updateLocalizedTexts() {
            document.title = SCRIPT_TEXTS[userLang].init; // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            messageElement.textContent = SCRIPT_TEXTS[userLang].init;
            payButton.textContent = SCRIPT_TEXTS[userLang].pay_button;
        }

        function showUserMessage(typeKey, additionalInfo = '') {
            messageElement.textContent = (SCRIPT_TEXTS[userLang][typeKey] || typeKey) + (additionalInfo ? ` (${additionalInfo})` : '');
            messageElement.classList.remove('error-message'); // –°–Ω–∞—á–∞–ª–∞ —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –æ—à–∏–±–∫–∏
            if (typeKey.startsWith('error_')) {
                messageElement.classList.add('error-message');
                loaderElement.style.display = 'none';
                payButton.style.display = 'none';
            }
        }
        
        async function initializePaymentProcess() {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            const planType = urlParams.get('plan_type');
            const langParam = urlParams.get('lang');
            const clientFirstName = urlParams.get('client_first_name');
            const clientLastName = urlParams.get('client_last_name');
            const clientPhone = urlParams.get('client_phone');
            const clientEmail = urlParams.get('client_email');

            if (langParam && SCRIPT_TEXTS[langParam]) {
                userLang = langParam;
                document.documentElement.lang = userLang; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –¥–ª—è HTML –¥–æ–∫—É–º–µ–Ω—Ç–∞
            }
            updateLocalizedTexts(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞

            if (!userId || !planType || !userLang) {
                showUserMessage('error_details');
                return;
            }

            const backendApiUrl = 'https://payapi.dreamcatcher.guru/api/pay/get-widget-params'; 
            
            try {
                console.log(`Requesting widget params from ${backendApiUrl} with user_id: ${userId}, plan_type: ${planType}, lang: ${userLang}`);

                let requestBody = { 
                    user_id: userId, 
                    plan_type: planType, 
                    lang: userLang
                };

                if (clientFirstName) requestBody.client_first_name = clientFirstName;
                if (clientLastName) requestBody.client_last_name = clientLastName;
                if (clientPhone) requestBody.client_phone = clientPhone;
                if (clientEmail) requestBody.client_email = clientEmail;

                const response = await fetch(backendApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Server responded with error:", response.status, errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                widgetPaymentParams = await response.json();
                console.log("Widget params loaded successfully:", widgetPaymentParams);
                
                loaderElement.style.display = 'none';
                payButton.style.display = 'inline-block'; 
                messageElement.textContent = "–ì–æ—Ç–æ–≤–æ –∫ –æ–ø–ª–∞—Ç–µ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '" + SCRIPT_TEXTS[userLang].pay_button + "'.";

            } catch (error) {
                console.error("Error fetching widget params:", error);
                showUserMessage('error_server', error.message);
            }
        }

        function triggerPayment() {
            if (!widgetPaymentParams) {
                showUserMessage('error_widget', '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
                console.error("triggerPayment called but widgetPaymentParams is null.");
                return;
            }
            payButton.disabled = true;
            loaderElement.style.display = 'block';
            showUserMessage('redirecting'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏

            var wayforpay = new Wayforpay(); // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∑–¥–µ—Å—å
            wayforpay.run(
                widgetPaymentParams, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                function (response) { // onApproved
                    console.log("WFP Approved:", response);
                    showUserMessage('approved');
                    loaderElement.style.display = 'none';
                    payButton.style.display = 'none';
                    // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç—å Telegram WebApp
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.close();
                    }
                },
                function (response) { // onDeclined
                    console.log("WFP Declined:", response);
                    showUserMessage('declined', response.reason || '');
                    loaderElement.style.display = 'none';
                    payButton.disabled = false; 
                    payButton.style.display = 'inline-block';
                },
                function (response) { // onPending or inProcessing
                    console.log("WFP Pending:", response);
                    showUserMessage('pending');
                    loaderElement.style.display = 'none';
                    payButton.style.display = 'none';
                }
            );
        }
        
        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è postMessage –æ—Ç –≤–∏–¥–∂–µ—Ç–∞
        window.addEventListener("message", function (event) {
            // –í–∞–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å origin –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            if (event.origin !== "https://secure.wayforpay.com") { 
                return;
            }
            console.log("Received postMessage event from WayForPay:", event.data);
            let closeWebView = false;
            if (event.data == 'WfpWidgetEventApproved') {
                showUserMessage('approved');
                closeWebView = true;
            } else if (event.data == 'WfpWidgetEventDeclined') {
                showUserMessage('declined');
                // –ö–Ω–æ–ø–∫—É –º–æ–∂–Ω–æ —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –≤–∏–¥–∂–µ—Ç —Å–∞–º –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
            } else if (event.data == 'WfpWidgetEventPending') {
                showUserMessage('pending');
            } else if (event.data == 'WfpWidgetEventClose') {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª –≤–∏–¥–∂–µ—Ç
                closeWebView = true; 
            }

            if (closeWebView && window.Telegram && window.Telegram.WebApp) {
                // –î–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
                setTimeout(() => { window.Telegram.WebApp.close(); }, 3000);
            }
        }, false);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = initializePaymentProcess;
    </script>
</body>
</html>